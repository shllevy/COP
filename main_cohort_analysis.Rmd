---
title: "analysis_01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tableone)
library(tidyverse)
library(visdat)
library(clipr)
library(jtools)?library(ggpubr)
library(MASS)
library(emmeans)
library(stats)
library(ggridges)
library(lme4)
library(stringi)
library(survival)
library(survminer)
library(cmprsk)
library(datapasta)
library(stringr)
library(lubridate)
library(sjPlot)
library(extrafont)
lo?dfonts(device = "win")
set.seed(1)
source("R/loading-data.r")
source("R/function_load.r")
source("R/data_preparation.r")
```


```{r}
# Table 1. Demographic characteristics of the Clalit-Booster study participants
myVar <-
  c("Positive_Covid_name",
    "g?nder",
    "age",
    "age_grp",
    "ethnicity",
    "socioeconomic_score_five_level_scale",
    "sector_of_occuppation_n",
    "hospital",
    "time_from_third_vaccine",
    "covid_pcrlab_count_count",
    "daily_interaction_with_corona_subjects",
    "t?me_FU")

strata_1 <- "vaccinated"
tableone_1 <-
  CreateTableOne(
    vars = myVar,
    data = df_work,
    strata = strata_1,
    addOverall = TRUE
  )
print(tableone_1, quote = TRUE, noSpaces = TRUE, nonnormal = c("covid_pcrlab_count_count", "time_from_t?ird_vaccine", "time_FU"))
write_excel_csv(df_work, "tomer_data_02_06_2022.csv")
```


```{r}
# Supplementary Data 4.
# Characteristics of the 74 individuals in the immunogenicity subset used in the study, which included 38 low-baseline and 36 high-baselin??individuals. P-values were computed using a t-test was used to compare the continuous variables and chi-square test for categorical data.
df_groups_shosh[,`:=`(num = as.character(num))]
df_groups_shosh[,`:=`(num = str_replace_all(num, fixed(" "), ""))]
df??ork <- df_groups_shosh[df_work, on = "num"]
df_work_table_shosh <- df_work[!is.na(group)]

myVar <-
  c("vaccinated",
    "Positive_Covid_name",
    "Positive_Covid_name_30_days",
    "gender",
    "age",
    "age_grp",
    "ethnicity",
    "socioeconomic??core_five_level_scale",
    "sector_of_occuppation_n",
    "hospital",
    "time_from_third_vaccine",
    "covid_pcrlab_count_count",
    "daily_interaction_with_corona_subjects")

strata_1 <- "group"
tableone_1 <-
  CreateTableOne(
    vars = myVar,
    ??ta = df_work_table_shosh,
    strata = strata_1,
    addOverall = TRUE
  )
print(tableone_1, quote = TRUE, noSpaces = TRUE, nonnormal = c("covid_pcrlab_count_count", "time_from_third_vaccine"))
```


```{r}
# Supplementary Table 2.
# P-values were compute??using a two-sided Cox proportional hazard model estimating vaccine efficacy at 60-90 follow up days. The model used calendar days as the time-axis and was adjusted for age, occupation, medical center, and time from the third vaccination.
ph_model <- coxph??  Surv(time = time_since_first_enroll, time2 = time_event_calendar, event) ~ vaccinated + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
  data = df_work
) 
model_cox_vacc_summary <- summary(ph_model)
table_summar??coef <- as.data.table(model_cox_vacc_summary$coefficients, keep.rownames = T)
table_summary_hr <- as.data.table(model_cox_vacc_summary$conf.int, keep.rownames = T)
write_excel_csv(table_summary_hr, "output/vaccination_cox_model_total_fu.csv")
write_excel_??v(table_summary_coef, "output/vaccination_cox_model_total_fu_p_value.csv")


# Supplementary Table 1.
# P-values were computed using a two-sided Cox proportional hazard model estimating vaccine efficacy for 30 follow up days. The model used calendar days ?? the time-axis and was adjusted for age, occupation, medical center, and time from the third vaccination.
ph_model_30 <- coxph(
  Surv(time = time_since_first_enroll, time2 = time_event_calendar_30, event_30) ~ vaccinated + gender + age_grp + sector_of_oc??ppation_grp + hospital + time_from_third_vaccine_month,
  data = df_work
) 

model_cox_vacc_summary_30 <- summary(ph_model_30)
table_summary_coef_30 <- as.data.table(model_cox_vacc_summary_30$coefficients, keep.rownames = T)
table_summary_hr_30 <- as.data??able(model_cox_vacc_summary_30$conf.int, keep.rownames = T)
write_excel_csv(table_summary_hr_30, "output/vaccination_cox_model_30_fu.csv")
write_excel_csv(table_summary_coef_30, "output/vaccination_cox_model_30_fu_p_value.csv")

```


```{r}
# Fig 1. f Va??ine efficacy
variables_all_vector <-
  c(colnames(df_work)[colnames(df_work) %like% "comb_vacc"],
    colnames(df_work)[colnames(df_work) %like% "comb_unvacc"],
    colnames(df_work)[colnames(df_work) %like% "group_vaccinated_no_mid"],
    colnames(df_wor??[colnames(df_work) %like% "group_unvaccinated_no_mid"])
# Reverse factor for many columns
# df_work[, (variables_all_vector) := lapply(.SD, fct_rev), .SDcols = variables_all_vector]


lm_fit <-
  survfit(Surv(time_to_event, event) ~ vaccinated, data = df_??rk)
p1 <- ggsurvplot(
  fit = lm_fit,
  xlab = "Days",
  ylab = "Cumulative Incidence (%)",
  risk.table = TRUE,
  fun = "event",
  conf.int = TRUE,
  cumevents = TRUE,
  palette = c("#FF8C00", "#0F3B5F"),
  xlim = c(0, 90),
  break.time.by = 7,
  risk.ta??e.y.text.col = T,
  risk.table.height = 0.25,
  conf.int.style = "ribbon",
  surv.scale = "percent",
  ggtheme = theme_classic(),
  tables.col = "black",
  linetype = "solid",
  censor = FALSE,
  legend.labs = c("Three doses", "Four doses")
)
p1_n <- p1$p??t + theme(
  text = element_text(size  = 24, family = "Times New Roman"),
  legend.position = c(1, 1.06),
  legend.justification = c("right", "top"),
  legend.title = element_blank()
)  + scale_x_continuous(expand = c(0, 0), breaks = c(seq(0, 90, 10))) +
??scale_y_continuous(
    expand = c(0, 0),
    limits = c(0, 0.8),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7 , 0.8),
    labels = c(0, 10, 20, 30, 40, 50, 60, 70, 100)
  )

p_2 <- p1_n + theme(axis.line.y = element_blank()) +
  annotate(
    geom?? "segment",
    x = -Inf,
    xend = -Inf,
    y = -Inf,
    yend = 0.74
  ) +
  annotate(
    geom = "segment",
    x = -Inf,
    xend = -Inf,
    y = Inf,
    yend = 0.76
  ) +
  coord_cartesian(clip = "off", xlim = c(0, 90)) +
  annotate(
    geom = "s??ment",
    x = -0.8,
    xend = 0.8,
    y = 0.731,
    yend = 0.749,
    size = 1
  ) + annotate(
    geom = "segment",
    x = -0.8,
    xend = 0.8,
    y = 0.751,
    yend = 0.769,
    size = 1
  ) + theme(plot.margin = margin(1, 1, 1, 1, "cm"))  + gui??s(color = guide_legend(override.aes =
                                                                                     list(fill = NA)))
p2 = p_2 + geom_vline(xintercept = 30, linetype = "dashed") + theme(plot.margin = margin(
  t = 8,
  r = 10,
  b =??,
  l = 2
))
p2
ggsave(
  filename = "vaccination effect.png",
  plot = last_plot(),
  dpi = 600,
  scale = 1.5,
  width = 7,
  height = 4
)
```

```{r}
# Fig 4 a-c three doses
variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "group_unvacci??ted_no_mid"]
km_syntax <- Surv(time_to_event, event) ~ exposure
table_count_single_unvacc <-
  data.table(groups = NA, N = NA, Events = NA)

lm_fit <- NULL
for (i in variable_vector) {
  lm_fit <- survfit(reformulate(i, km_syntax[[2]]), data = df_work)
  ?? <- ggsurvplot(
    fit = lm_fit,
    xlab = "Days",
    ylab = "Cumulative Incidence (%)",
    risk.table = TRUE,
    fun = "event",
    conf.int = TRUE,
    cumevents = TRUE,
    palette = c("#609492", "#861D20"),
    xlim = c(0, 90),
    break.time.by ??7,
    risk.table.y.text.col = T,
    risk.table.height = 0.25,
    conf.int.style = "ribbon",
    surv.scale = "percent",
    ggtheme = theme_classic(),
    tables.col = "black",
    linetype = "solid",
    censor = FALSE,
    legend.labs = levels(df_wor??, get(i)])
  )
  
  surv_diff_data <-
    survdiff(reformulate(i, km_syntax[[2]]), data = df_work)
  table_count_single_unvacc <-
    rbindlist(list(
      table_count_single_unvacc,
      data.table(surv_diff_data$n, Events = surv_diff_data$obs)
    ))
 ??  p1_n <- p1$plot + theme(
    text = element_text(size  = 24, family = "Times New Roman"),
    legend.position = c(1, 1.06),
    legend.justification = c("right", "top"),
    legend.title = element_blank()
  )  + scale_x_continuous(expand = c(0, 0), brea?? = c(seq(0, 90, 10))) +
    scale_y_continuous(
      expand = c(0, 0),
      limits = c(0, 0.8),
      breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7 , 0.8),
      labels = c(0, 10, 20, 30, 40, 50, 60, 70, 100)
    )
  
  p_2 <- p1_n + theme(axis.line.y?? element_blank()) +
    annotate(
      geom = "segment",
      x = -Inf,
      xend = -Inf,
      y = -Inf,
      yend = 0.74
    ) +
    annotate(
      geom = "segment",
      x = -Inf,
      xend = -Inf,
      y = Inf,
      yend = 0.76
    ) +
    co??d_cartesian(clip = "off", xlim = c(0, 90)) +
    annotate(
      geom = "segment",
      x = -0.8,
      xend = 0.8,
      y = 0.731,
      yend = 0.749,
      size = 1
    ) + annotate(
      geom = "segment",
      x = -0.8,
      xend = 0.8,
      y = ??751,
      yend = 0.769,
      size = 1
    ) + theme(plot.margin = margin(1, 1, 1, 1, "cm"),
              legend.position = "none")  + guides(color = guide_legend(override.aes =
                                                                         li??(fill = NA)))
  p2 = p_2 + geom_vline(xintercept = 30, linetype = "dashed") + theme(plot.margin = margin(
    t = 8,
    r = 10,
    b = 0,
    l = 2
  ))
  p2
  ggsave(
    filename = paste0("unvaccinated/", i, ".png"),
    plot = last_plot(),
    dpi = ??0,
    scale = 1.5,
    width = 7,
    height = 4
  )
  
  # ggsave(plot = p2, paste0("unvaccinated/", i, ".tiff"), dpi=300, scale = 1.5, width = 7, height = 4)
}
write_excel_csv(table_count_single_unvacc,
                "output/sample_size_singe_unvacc.??v")

```

```{r}
# Fig 4 a-c four doses
variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "group_vaccinated_no_mid"]
km_syntax <- Surv(time_to_event, event) ~ exposure
table_count_single_vacc <-
  data.table(groups = NA, N = NA, Events = NA)??lm_fit <- NULL
for (i in variable_vector) {
  lm_fit <- survfit(reformulate(i, km_syntax[[2]]), data = df_work)
  p1 <- ggsurvplot(
    fit = lm_fit,
    xlab = "Days",
    ylab = "Cumulative Incidence (%)",
    risk.table = TRUE,
    fun = "event",
    c??f.int = TRUE,
    cumevents = TRUE,
    palette = c("#609492", "#861D20"),
    xlim = c(0, 90),
    break.time.by = 7,
    risk.table.y.text.col = T,
    risk.table.height = 0.25,
    conf.int.style = "ribbon",
    surv.scale = "percent",
    ggtheme = th??e_classic(),
    tables.col = "black",
    linetype = "solid",
    censor = FALSE,
    legend.labs = levels(df_work[, get(i)])
  )
  surv_diff_data <-
    survdiff(reformulate(i, km_syntax[[2]]), data = df_work)
  table_count_single_vacc <-
    rbindlist(??st(
      table_count_single_vacc,
      data.table(surv_diff_data$n, Events = surv_diff_data$obs)
    ))
  
  p1_n <- p1$plot + theme(
    text = element_text(size  = 24, family = "Times New Roman"),
    legend.position = c(1, 1.06),
    legend.justifica??on = c("right", "top"),
    legend.title = element_blank()
  ) + scale_x_continuous(expand = c(0, 0), breaks = c(seq(0, 90, 10))) +
    scale_y_continuous(
      expand = c(0, 0),
      limits = c(0, 0.8),
      breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6,??.7 , 0.8),
      labels = c(0, 10, 20, 30, 40, 50, 60, 70, 100)
    )
  
  p_2 <- p1_n + theme(axis.line.y = element_blank()) +
    annotate(
      geom = "segment",
      x = -Inf,
      xend = -Inf,
      y = -Inf,
      yend = 0.74
    ) +
    annotate??      geom = "segment",
      x = -Inf,
      xend = -Inf,
      y = Inf,
      yend = 0.76
    ) +
    coord_cartesian(clip = "off", xlim = c(0, 90)) +
    annotate(
      geom = "segment",
      x = -0.8,
      xend = 0.8,
      y = 0.731,
      yend = ??749,
      size = 1
    ) + annotate(
      geom = "segment",
      x = -0.8,
      xend = 0.8,
      y = 0.751,
      yend = 0.769,
      size = 1
    ) + theme(plot.margin = margin(1, 1, 1, 1, "cm"),
              legend.position = "none")  + guides(col?? = guide_legend(override.aes =
                                                                         list(fill = NA)))
  p2 = p_2 + geom_vline(xintercept = 30, linetype = "dashed") + theme(plot.margin = margin(
    t = 8,
    r = 10,
    b = 0,
    l =??
  ))
  p2
  ggsave(
    filename = paste0("vaccinated/", i, ".png"),
    plot = last_plot(),
    dpi = 600,
    scale = 1.5,
    width = 7,
    height = 4
  )
  # ggsave(plot = p2, paste0("vaccinated/", i, ".eps"), dpi=300, scale = 1.5, width = 7, height?? 4)
}
write_excel_csv(table_count_single_vacc,
                "output/sample_size_singe_vacc.csv")
```


```{r}
# Fig 5 a-b three doses
variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "comb_unvacc"]
km_syntax <- Surv(time_to_event, event)?? exposure
table_count_combination_unvacc <-
  data.table(groups = NA, N = NA, Events = NA)

lm_fit <- NULL
for (i in variable_vector) {
  lm_fit <- survfit(reformulate(i, km_syntax[[2]]), data = df_work)
  p1 <- ggsurvplot(
    fit = lm_fit,
    xlab = "D??s",
    ylab = "Cumulative Incidence (%)",
    risk.table = TRUE,
    fun = "event",
    conf.int = TRUE,
    cumevents = TRUE,
    palette = c("#609492", "#861D20"),
    xlim = c(0, 90),
    break.time.by = 7,
    risk.table.y.text.col = T,
    risk.tabl??height = 0.25,
    conf.int.style = "ribbon",
    surv.scale = "percent",
    ggtheme = theme_classic(),
    tables.col = "black",
    linetype = "solid",
    censor = FALSE,
    legend.labs = levels(df_work[, get(i)])
  )
  
  surv_diff_data <-
    survd??f(reformulate(i, km_syntax[[2]]), data = df_work)
  table_count_combination_unvacc <-
    rbindlist(list(
      table_count_combination_unvacc,
      data.table(surv_diff_data$n, Events = surv_diff_data$obs)
    ))
  
  p1_n <- p1$plot + theme(
    text =??lement_text(size  = 24, family = "Times New Roman"),
    legend.position = c(1, 1.06),
    legend.justification = c("right", "top"),
    legend.title = element_blank()
  ) + scale_x_continuous(expand = c(0, 0), breaks = c(seq(0, 90, 10))) +
    scale_y_co??inuous(
      expand = c(0, 0),
      limits = c(0, 0.8),
      breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7 , 0.8),
      labels = c(0, 10, 20, 30, 40, 50, 60, 70, 100)
    )
  
  p_2 <- p1_n + theme(axis.line.y = element_blank()) +
    annotate(
    ??geom = "segment",
      x = -Inf,
      xend = -Inf,
      y = -Inf,
      yend = 0.74
    ) +
    annotate(
      geom = "segment",
      x = -Inf,
      xend = -Inf,
      y = Inf,
      yend = 0.76
    ) +
    coord_cartesian(clip = "off", xlim = c(0, ??)) +
    annotate(
      geom = "segment",
      x = -0.8,
      xend = 0.8,
      y = 0.731,
      yend = 0.749,
      size = 1
    ) + annotate(
      geom = "segment",
      x = -0.8,
      xend = 0.8,
      y = 0.751,
      yend = 0.769,
      size = ??    ) + theme(plot.margin = margin(1, 1, 1, 1, "cm"),
              legend.position = "none")  + guides(color = guide_legend(override.aes =
                                                                         list(fill = NA)))
  p2 = p_2 + geom_vline(??ntercept = 30, linetype = "dashed") + theme(plot.margin = margin(
    t = 8,
    r = 10,
    b = 0,
    l = 2
  ))
  p2
  ggsave(
    filename = paste0("unvaccinated_comb/", i, ".png"),
    plot = last_plot(),
    dpi = 600,
    scale = 1.5,
    width = 7??    height = 4
  )
  
  # ggsave(plot = p2, paste0("unvaccinated_comb/", i, ".tiff"), dpi=300, scale = 1.5, width = 7, height = 4)
}
write_excel_csv(table_count_combination_unvacc,
                "output/sample_size_combination_unvacc.csv")
```

```{r}
#??ig 5 a-b four doses
variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "comb_vacc"]
km_syntax <- Surv(time_to_event, event) ~ exposure
table_count_combination_vacc <-
  data.table(groups = NA, N = NA, Events = NA)

lm_fit <- NULL
for (i in va??able_vector) {
  lm_fit <- survfit(reformulate(i, km_syntax[[2]]), data = df_work)
  p1 <- ggsurvplot(
    fit = lm_fit,
    xlab = "Days",
    ylab = "Cumulative Incidence (%)",
    risk.table = TRUE,
    fun = "event",
    conf.int = TRUE,
    cumevents?? TRUE,
    palette = c("#609492", "#861D20"),
    xlim = c(0, 90),
    break.time.by = 7,
    risk.table.y.text.col = T,
    risk.table.height = 0.25,
    conf.int.style = "ribbon",
    surv.scale = "percent",
    ggtheme = theme_classic(),
    tables.col?? "black",
    linetype = "solid",
    censor = FALSE,
    legend.labs = levels(df_work[, get(i)])
  )
  
  surv_diff_data <-
    survdiff(reformulate(i, km_syntax[[2]]), data = df_work)
  table_count_combination_vacc <-
    rbindlist(list(
      table_cou??_combination_vacc,
      data.table(surv_diff_data$n, Events = surv_diff_data$obs)
    ))
  
  
  p1_n <- p1$plot + theme(
    text = element_text(size  = 24, family = "Times New Roman"),
    legend.position = c(1, 1.06),
    legend.justification = c("rig??", "top"),
    legend.title = element_blank()
  ) + scale_x_continuous(expand = c(0, 0), breaks = c(seq(0, 90, 10))) +
    scale_y_continuous(
      expand = c(0, 0),
      limits = c(0, 0.8),
      breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7 , 0.8),
??    labels = c(0, 10, 20, 30, 40, 50, 60, 70, 100)
    )
  
  p_2 <- p1_n + theme(axis.line.y = element_blank()) +
    annotate(
      geom = "segment",
      x = -Inf,
      xend = -Inf,
      y = -Inf,
      yend = 0.74
    ) +
    annotate(
      geom ??"segment",
      x = -Inf,
      xend = -Inf,
      y = Inf,
      yend = 0.76
    ) +
    coord_cartesian(clip = "off", xlim = c(0, 90)) +
    annotate(
      geom = "segment",
      x = -0.8,
      xend = 0.8,
      y = 0.731,
      yend = 0.749,
      ??ze = 1
    ) + annotate(
      geom = "segment",
      x = -0.8,
      xend = 0.8,
      y = 0.751,
      yend = 0.769,
      size = 1
    ) + theme(plot.margin = margin(1, 1, 1, 1, "cm"),
              legend.position = "none")  + guides(color = guide_le??nd(override.aes =
                                                                         list(fill = NA)))
  p2 = p_2 + geom_vline(xintercept = 30, linetype = "dashed")  + theme(plot.margin = margin(
    t = 8,
    r = 10,
    b = 0,
    l = 2
  ))
  p2?? ggsave(
    filename = paste0("vaccinated_comb/", i, ".png"),
    plot = last_plot(),
    dpi = 600,
    scale = 1.5,
    width = 7,
    height = 4
  )
  
  # ggsave(plot = p2, paste0("vaccinated_comb/", i, ".tiff"), dpi=300, scale = 1.5, width = 7, heig?? = 4)
}
write_excel_csv(table_count_combination_vacc,
                "output/sample_size_combination_vacc.csv")
```

```{r}
# Analysis For Fig 5d and Fig6c and Supplementary Table 5 and 6
# Fig 5. d, all follow-up, four doses
cox_model <-
  coxph(
    Su??(time = time_since_first_enroll, time2 = time_event_calendar, event) ~ s2_group_vaccinated_no_mid + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
model_coef_vacc_90 <-
  cbind(
    as.data.??ble(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as.data.table(summary(cox_model)$coefficients)[1, 5]
  )

variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "group_vaccinated_no_mid"]
variable_vector <- variable_vector[-1]
for (??in variable_vector) {
  cox_syntax <-
    as.formula(
      substitute(
        Surv(time = time_since_first_enroll, time2 = time_event_calendar, event) ~ s2_group_vaccinated_no_mid + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_thi??_vaccine_month,
        list(s2_group_vaccinated_no_mid = as.symbol(i))
      )
    )
  model_temp_cox <- coxph(cox_syntax, data = df_work)
  model_coef_vacc_90 <-
    rbindlist(list(
      model_coef_vacc_90,
      cbind(
        as.data.table(summary(mo??l_temp_cox)$conf.int, keep.rownames = T)[1, ],
        as.data.table(summary(model_temp_cox)$coefficients)[1, 5]
      )
    ))
}

model_coef_vacc_90

# Fig 5. d, 30 days, four doses
cox_model <-
  coxph(
    Surv(time = time_since_first_enroll, time2 = t??e_event_calendar_30, event_30) ~ s2_group_vaccinated_no_mid + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
model_coef_vacc_30 <-
  cbind(
    as.data.table(summary(cox_model)$conf.int, kee??rownames = T)[1, ],
    as.data.table(summary(cox_model)$coefficients)[1, 5]
  )

variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "group_vaccinated_no_mid"]
variable_vector <- variable_vector[-1]
for (i in variable_vector) {
  cox_syntax <??    as.formula(
      substitute(
        Surv(time = time_since_first_enroll, time2 = time_event_calendar_30, event_30) ~ s2_group_vaccinated_no_mid + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
        list(s??group_vaccinated_no_mid = as.symbol(i))
      )
    )
  model_temp_cox <- coxph(cox_syntax, data = df_work)
  model_coef_vacc_30 <-
    rbindlist(list(
      model_coef_vacc_30,
      cbind(
        as.data.table(summary(model_temp_cox)$conf.int, keep.row??mes = T)[1, ],
        as.data.table(summary(model_temp_cox)$coefficients)[1, 5]
      )
    ))
}
model_coef_vacc_30

# Fig 5. d, all follow-up, three doses
cox_model <-
  coxph(
    Surv(time = time_since_first_enroll, time2 = time_event_calendar, event)?? s2_group_unvaccinated_no_mid + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
model_coef_unvacc_90 <-
  cbind(
    as.data.table(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as??ata.table(summary(cox_model)$coefficients)[1, 5]
  )

variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "group_unvaccinated_no_mid"]
variable_vector <- variable_vector[-1]
for (i in variable_vector) {
  cox_syntax <-
    as.formula(
      su??titute(
        Surv(time = time_since_first_enroll, time2 = time_event_calendar, event) ~ s2_group_unvaccinated_no_mid + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
        list(s2_group_unvaccinated_no_mid = ??.symbol(i))
      )
    )
  model_temp_cox <- coxph(cox_syntax, data = df_work)
  model_coef_unvacc_90 <-
    rbindlist(list(
      model_coef_unvacc_90,
      cbind(
        as.data.table(summary(model_temp_cox)$conf.int, keep.rownames = T)[1, ],
       ??s.data.table(summary(model_temp_cox)$coefficients)[1, 5]
      )
    ))
}

model_coef_unvacc_90


# Fig 5. d, 30 days, three doses
cox_model <-
  coxph(
    Surv(time = time_since_first_enroll, time2 = time_event_calendar_30, event_30) ~ s2_group_unvaccin??ed_no_mid + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
model_coef_unvacc_30 <-
  cbind(
    as.data.table(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as.data.table(summary(??x_model)$coefficients)[1, 5]
  )

variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "group_unvaccinated_no_mid"]
variable_vector <- variable_vector[-1]
for (i in variable_vector) {
  cox_syntax <-
    as.formula(
      substitute(
        Su??(time = time_since_first_enroll, time2 = time_event_calendar_30, event_30) ~ s2_group_unvaccinated_no_mid + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
        list(s2_group_unvaccinated_no_mid = as.symbol(i))
??    )
    )
  model_temp_cox <- coxph(cox_syntax, data = df_work)
  model_coef_unvacc_30 <-
    rbindlist(list(
      model_coef_unvacc_30,
      cbind(
        as.data.table(summary(model_temp_cox)$conf.int, keep.rownames = T)[1, ],
        as.data.table??ummary(model_temp_cox)$coefficients)[1, 5]
      )
    ))
}
model_coef_unvacc_30

# Fig 6. c, all follow-up, four doses
cox_model <-
  coxph(
    Surv(time = time_since_first_enroll, time2 = time_event_calendar, event) ~ alinity_variants_iga_comb_unvacc +??ender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
model_coef_unvacc_comb_90 <-
  cbind(
    as.data.table(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as.data.table(summary(cox_mode??$coefficients)[1, 5]
  )

variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "comb_unvacc"]
variable_vector <- variable_vector[-1]
for (i in variable_vector) {
  cox_syntax <-
    as.formula(
      substitute(
        Surv(time = time_since_f??st_enroll, time2 = time_event_calendar, event) ~ alinity_variants_iga_comb_unvacc + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
        list(alinity_variants_iga_comb_unvacc = as.symbol(i))
      )
    )
  mode??temp_cox <- coxph(cox_syntax, data = df_work)
  model_coef_unvacc_comb_90 <-
    rbindlist(list(
      model_coef_unvacc_comb_90,
      cbind(
        as.data.table(summary(model_temp_cox)$conf.int, keep.rownames = T)[1, ],
        as.data.table(summary(m??el_temp_cox)$coefficients)[1, 5]
      )
    ))
}

model_coef_unvacc_comb_90


# Fig 6. c, 30 days, four doses
cox_model <-
  coxph(
    Surv(time = time_since_first_enroll, time2 = time_event_calendar_30, event_30) ~ alinity_variants_iga_comb_unvacc + ge??er + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
model_coef_unvacc_comb_30 <-
  cbind(
    as.data.table(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as.data.table(summary(cox_model)$??efficients)[1, 5]
  )

variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "comb_unvacc"]
variable_vector <- variable_vector[-1]
for (i in variable_vector) {
  cox_syntax <-
    as.formula(
      substitute(
        Surv(time = time_since_firs??enroll, time2 = time_event_calendar_30, event_30) ~ alinity_variants_iga_comb_unvacc + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
        list(alinity_variants_iga_comb_unvacc = as.symbol(i))
      )
    )
  m??el_temp_cox <- coxph(cox_syntax, data = df_work)
  model_coef_unvacc_comb_30 <-
    rbindlist(list(
      model_coef_unvacc_comb_30,
      cbind(
        as.data.table(summary(model_temp_cox)$conf.int, keep.rownames = T)[1, ],
        as.data.table(summar??model_temp_cox)$coefficients)[1, 5]
      )
    ))
}
model_coef_unvacc_comb_30


# Fig 6. c, all follow-up, three doses
cox_model <-
  coxph(
    Surv(time = time_since_first_enroll, time2 = time_event_calendar, event) ~ s2_variants_iga_comb_vacc + gender?? age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
model_coef_vacc_comb_90 <-
  cbind(
    as.data.table(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as.data.table(summary(cox_model)$coeffi??ents)[1, 5]
  )

variable_vector <-
  colnames(df_work)[colnames(df_work) %like% "comb_vacc"]
variable_vector <- variable_vector[-1]
for (i in variable_vector) {
  cox_syntax <-
    as.formula(
      substitute(
        Surv(time = time_since_first_enroll??time2 = time_event_calendar, event) ~ s2_variants_iga_comb_vacc + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
        list(s2_variants_iga_comb_vacc = as.symbol(i))
      )
    )
  model_temp_cox <- coxph(cox_s??tax, data = df_work)
  model_coef_vacc_comb_90 <-
    rbindlist(list(
      model_coef_vacc_comb_90,
      cbind(
        as.data.table(summary(model_temp_cox)$conf.int, keep.rownames = T)[1, ],
        as.data.table(summary(model_temp_cox)$coefficients)[?? 5]
      )
    ))
}

model_coef_vacc_comb_90


# Fig 6. c, 30 days, three doses
cox_model <-
  coxph(
    Surv(time = time_since_first_enroll, time2 = time_event_calendar_30, event_30) ~ s2_variants_iga_comb_vacc + gender + age_grp + sector_of_occuppatio??grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
model_coef_vacc_comb_30 <-
  cbind(
    as.data.table(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as.data.table(summary(cox_model)$coefficients)[1, 5]
  )

variable_vecto??<-
  colnames(df_work)[colnames(df_work) %like% "comb_vacc"]
variable_vector <- variable_vector[-1]
for (i in variable_vector) {
  cox_syntax <-
    as.formula(
      substitute(
        Surv(time = time_since_first_enroll, time2 = time_event_calendar_30,??vent_30) ~ s2_variants_iga_comb_vacc + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
        list(s2_variants_iga_comb_vacc = as.symbol(i))
      )
    )
  model_temp_cox <- coxph(cox_syntax, data = df_work)
  mo??l_coef_vacc_comb_30 <-
    rbindlist(list(
      model_coef_vacc_comb_30,
      cbind(
        as.data.table(summary(model_temp_cox)$conf.int, keep.rownames = T)[1, ],
        as.data.table(summary(model_temp_cox)$coefficients)[1, 5]
      )
    ))
}
mode??coef_vacc_comb_30

# Forestplots Fig 5d and Fig6
variables_all_vector_comb <-
  c(colnames(df_work)[colnames(df_work) %like% "comb_vacc"], colnames(df_work)[colnames(df_work) %like% "comb_unvacc"])
variables_all_vector_single <-
  c(colnames(df_work)[coln??es(df_work) %like% "group_vaccinated_no_mid"], colnames(df_work)[colnames(df_work) %like% "group_unvaccinated_no_mid"])

vector_filter_antibody_names_single <- NULL
for (i in variables_all_vector_single) {
  vector_filter_antibody_names_single = c(vector_??lter_antibody_names_single, levels(df_work[, get(i)])[2])
}
vector_filter_antibody_names_comb <- NULL
for (i in variables_all_vector_comb) {
  vector_filter_antibody_names_comb = c(vector_filter_antibody_names_comb, levels(df_work[, get(i)])[2])
}
# Add v??cination status variable
model_coef_unvacc_90$status <- "Three doses"
model_coef_unvacc_comb_90$status <- "Three doses"
model_coef_vacc_90$status <- "Four doses"
model_coef_vacc_comb_90$status <- "Four doses"

model_coef_unvacc_30$status <- "Three doses"
??del_coef_unvacc_comb_30$status <- "Three doses"
model_coef_vacc_30$status <- "Four doses"
model_coef_vacc_comb_30$status <- "Four doses"
# Add single vs combination type variable
model_coef_unvacc_90$type <- "single"
model_coef_unvacc_comb_90$type <- "com??nation"
model_coef_vacc_90$type <- "single"
model_coef_vacc_comb_90$type <- "combination"

model_coef_unvacc_30$type <- "single"
model_coef_unvacc_comb_30$type <- "combination"
model_coef_vacc_30$type <- "single"
model_coef_vacc_comb_30$type <- "combinati??"

hr_table_90 <-
  rbindlist(
    list(
      model_coef_unvacc_90,
      model_coef_unvacc_comb_90,
      model_coef_vacc_90,
      model_coef_vacc_comb_90
    )
  )
hr_table_30 <-
  rbindlist(
    list(
      model_coef_unvacc_30,
      model_coef_unva??_comb_30,
      model_coef_vacc_30,
      model_coef_vacc_comb_30
    )
  )

hr_table_90[, `:=`(hr = `exp(coef)`, LL = `lower .95`, UL = `upper .95`)]
hr_table_90[, `:=`(hr_label = paste0(round(hr, 2), " ", "[", round(LL, 2), ", ", round(UL, 2), "]"))]

h??table_30[, `:=`(hr = `exp(coef)`, LL = `lower .95`, UL = `upper .95`)]
hr_table_30[, `:=`(hr_label = paste0(round(hr, 2), " ", "[", round(LL, 2), ", ", round(UL, 2), "]"))]


hr_table_90[, `:=`(antibody_n = gsub("^.*\\_", "", rn))]
hr_table_30[, `:=`(anti??dy_n = gsub("^.*\\_", "", rn))]

hr_table_90[type == "single", `:=`(antibody_n = str_sub(antibody_n, 4,-1))]
hr_table_90[type == "combination" &
              status == "Four doses", `:=`(antibody_n = str_sub(antibody_n, 5,-1))]
hr_table_90[type == "combi??tion" &
              status == "Three doses", `:=`(antibody_n = str_sub(antibody_n, 7,-1))]
hr_table_30[type == "single", `:=`(antibody_n = str_sub(antibody_n, 4,-1))]
hr_table_30[type == "combination" &
              status == "Four doses", `:=`(antibod??n = str_sub(antibody_n, 5,-1))]
hr_table_30[type == "combination" &
              status == "Three doses", `:=`(antibody_n = str_sub(antibody_n, 7,-1))]
hr_table_90[, `:=`(antibody_n = word(antibody_n, 1,-2))]
hr_table_30[, `:=`(antibody_n = word(antibody??, 1,-2))]

hr_table_90_ordered <-
  hr_table_90[order(rn), .SD, by = c("status", "type")]
hr_table_30_ordered <-
  hr_table_30[order(rn), .SD, by = c("status", "type")]


write_excel_csv(hr_table_30_ordered, "output/hr_table_30.csv")
write_excel_csv(hr_ta??e_90_ordered, "output/hr_table_90.csv")

hr_table_90[, `:=`(antibody_n = gsub("&", "\n", antibody_n))]
hr_table_30[, `:=`(antibody_n = gsub("&", "\n", antibody_n))]

# Correction of upper limit for plot only
hr_table_90[rn == "Mutants_variants_iga_comb_va??IgG Mutants RBD & IgA Variants Low", `:=`(UL = 40)]
hr_table_30[rn == "Mutants_variants_iga_comb_vaccIgG Mutants RBD & IgA Variants Low", `:=`(UL = 40)]


hr_table_90_single = hr_table_90[type == "single"]

hr_table_90_single[, `:=`(antibody_n = factor(
 ??ntibody_n,
  levels = c(
    "IgA Wuhan RBD",
    "IgA Wuhan B.1.526 S",
    "IgA Wuhan B.1.621 S",
    "IgA Wuhan P S",
    "IgA Wuhan RBD N440K",
    "IgA Wuhan D614G",
    "IgA Wuhan",
    "IgA Variants",
    "IgG Mutants RBD",
    "IgG Alinity RBD",
 ?? "IgG BioPlex S2"
  ),
  labels = c(
    "IgA Wuhan RBD",
    "IgA Wuhan B.1.526 S",
    "IgA Wuhan B.1.621 S",
    "IgA Wuhan P S",
    "IgA Wuhan RBD N440K",
    "IgA Wuhan D614G",
    "IgA Wuhan",
    "IgA Variants",
    "IgG Mutants RBD" ,
    "IgG Al??ity RBD" ,
    "IgG BioPlex S2"
  )
))]

hr_table_90_single <-
  hr_table_90_single[antibody_n %in% c("IgA Wuhan",
                                       "IgA Variants",
                                       "IgG Mutants RBD",
                           ??          "IgG BioPlex S2",
                                       "IgG Alinity RBD")]

plot1 <-
  ggplot(subset(hr_table_90_single),
         aes(y = antibody_n, x = hr, color = status)) +
  geom_point(shape = 18,
             size = 5,
             posi??on = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = LL, xmax = UL),
                 height = 0.25,
                 position = position_dodge(width = 0.3)) +
  geom_vline(
    xintercept = 1,
    color = "black",
    linetype = "dashed",
    ??x = 1,
    alpha = 0.5
  ) +
  xlab("Hazard Ratio (95% CI)") +
  ylab(" ") +
  theme_bw() +
  theme(
    panel.border = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()??    axis.line = element_line(colour = "black", size = 0.566),
    axis.text.y = element_text(size = 22, colour = "black"),
    axis.text.x.bottom = element_text(size = 22, colour = "black"),
    axis.title.x = element_text(size = 22, colour = "black"),
  ??legend.position = "bottom",
    legend.title = element_blank(),
    text = element_text(size  = 22, family = "Times New Roman")
  ) +
  scale_x_continuous(
    trans = 'log10',
    limits = c(0.1, 100),
    labels = scales::label_number_auto()
  ) +
  sca??_color_manual(values = c("#0F3B5F", "#FF8C00")) +
  coord_cartesian(xlim = c(0.5, 30))  + theme(plot.margin = margin(
    t = 8,
    r = 10,
    b = 0,
    l = 2
  ))
plot1
ggsave(
  filename = paste0("forest_plots/single_all_FU", ".png"),
  plot = last_p??t(),
  dpi = 600,
  scale = 3,
  width = 3,
  height = 2
)

hr_table_30_single = hr_table_30[type == "single"]

hr_table_30_single[, `:=`(antibody_n = factor(
  antibody_n,
  levels = c(
    "IgA Wuhan RBD",
    "IgA Wuhan B.1.526 S",
    "IgA Wuhan B.1.6?? S",
    "IgA Wuhan P S",
    "IgA Wuhan RBD N440K",
    "IgA Wuhan D614G",
    "IgA Wuhan",
    "IgA Variants",
    "IgG Mutants RBD" ,
    "IgG Alinity RBD" ,
    "IgG BioPlex S2"
  ),
  labels = c(
    "IgA Wuhan RBD",
    "IgA Wuhan B.1.526 S",
    "I?? Wuhan B.1.621 S",
    "IgA Wuhan P S",
    "IgA Wuhan RBD N440K",
    "IgA Wuhan D614G",
    "IgA Wuhan",
    "IgA Variants",
    "IgG Mutants RBD" ,
    "IgG Alinity RBD" ,
    "IgG BioPlex S2"
  )
))]

hr_table_30_single <-
  hr_table_30_single[antibod??n %in% c("IgA Wuhan",
                                       "IgA Variants",
                                       "IgG Mutants RBD",
                                       "IgG BioPlex S2",
                                       "IgG Alinity RBD")]

plo?? <-
  ggplot(subset(hr_table_30_single),
         aes(y = antibody_n, x = hr, color = status)) +
  geom_point(shape = 18,
             size = 5,
             position = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = LL, xmax = UL),
           ??    height = 0.25,
                 position = position_dodge(width = 0.3)) +
  geom_vline(
    xintercept = 1,
    color = "black",
    linetype = "dashed",
    cex = 1,
    alpha = 0.3
  ) +
  xlab("Hazard Ratio (95% CI)") +
  ylab(" ") +
  theme_bw() +?? theme(
    panel.border = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black", size = 0.566),
    axis.text.y = element_tex??size = 22, colour = "black"),
    axis.text.x.bottom = element_text(size = 22, colour = "black"),
    axis.title.x = element_text(size = 22, colour = "black"),
    legend.position = "bottom",
    legend.title = element_blank(),
    text = element_text(siz?? = 22, family = "Times New Roman")
  ) + scale_x_continuous(
    trans = 'log10',
    limits = c(0.1, 100),
    labels = scales::label_number_auto()
  ) + scale_color_manual(values = c("#0F3B5F", "#FF8C00")) + coord_cartesian(xlim = c(0.5, 30)) +
  theme(??ot.margin = margin(
    t = 8,
    r = 10,
    b = 0,
    l = 2
  ))
plot1
ggsave(
  filename = paste0("forest_plots/single_T1", ".png"),
  plot = last_plot(),
  dpi = 600,
  scale = 3,
  width = 3,
  height = 2
)

hr_table_90_com = copy(hr_table_90[type ?? "combination"])
hr_table_90_com[antibody_n == "IgG Mutants RBD \n IgA Variants", `:=`(antibody_n = "IgG Mutants RBD \n IgA Variants")]
hr_table_90_com[antibody_n == "IgG Mutants RBD \n IgA Wuhan", `:=`(antibody_n = "IgG Mutants RBD \n IgA Wuhan")]
hr_tab??_90_com[antibody_n == "BioPlex IgG S2 \n IgG Alinity RBD", `:=`(antibody_n = "BioPlex IgG S2 \n IgG Alinity RBD")]
hr_table_90_com[, `:=`(antibody_n = factor(
  antibody_n,
  levels = c(
    "IgA Wuhan \n IgA Variants",
    "BioPlex IgG S2 \n IgG Alinity ??D",
    "IgG Alinity RBD \n IgG Mutants RBD",
    "BioPlex IgG S2 \n IgG Mutants RBD",
    "IgG Alinity RBD \n IgA Wuhan",
    "BioPlex IgG S2 \n IgA Variants",
    "BioPlex IgG S2 \n IgA Wuhan",
    "IgG Alinity RBD \n IgA Variants",
    "IgG Mutants RBD??n IgA Wuhan",
    "IgG Mutants RBD \n IgA Variants"
  ),
  labels = c(
    "IgA Wuhan \n \u0026        \n IgA Variants ",
    "BioPlex IgG S2 \n \u0026            \n IgG Alinity RBD ",
    "IgG Alinity RBD \n \u0026            \n IgG Mutants RBD ",
    "B??Plex IgG S2 \n \u0026            \n IgG Mutants RBD ",
    "IgG Alinity RBD \n \u0026            \n IgA Wuhan     ",
    "BioPlex IgG S2 \n \u0026            \n IgA Variants    ",
    "BioPlex IgG S2 \n \u0026            \n IgA Wuhan     ",
    "IgG Alini?? RBD \n \u0026            \n IgA Variants    ",
    "IgG Mutants RBD \n \u0026            \n IgA Wuhan     ",
    "IgG Mutants RBD \n \u0026            \n IgA Variants    "
  )
))]

plot1 <-
  ggplot(subset(hr_table_90_com),
         aes(y = antibody_n, x?? hr, color = status)) +
  geom_point(shape = 18,
             size = 5,
             position = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = LL, xmax = UL),
                 height = 0.25,
                 position = position_dodge(width = 0??)) +
  geom_vline(
    xintercept = 1,
    color = "black",
    linetype = "dashed",
    cex = 1,
    alpha = 0.3
  ) +
  xlab("Hazard Ratio (95% CI)") +
  ylab(" ") +
  theme_bw() +
  theme(
    panel.border = element_blank(),
    panel.background = elem??t_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    axis.text.y = element_text(size = 28, colour = "black"),
    axis.text.x.bottom = element_text(size = ??, colour = "black"),
    axis.title.x = element_text(size = 28, colour = "black"),
    legend.position = "bottom",
    legend.title = element_blank(),
    text = element_text(size  = 28, family = "Times New Roman")
  ) + scale_x_continuous(
    trans = 'l??10',
    limits = c(0.1, 100),
    labels = scales::label_number_auto()
  ) + scale_color_manual(values = c("#0F3B5F", "#FF8C00")) + coord_cartesian(xlim = c(0.5, 30)) +
  theme(plot.margin = margin(
    t = 8,
    r = 10,
    b = 0,
    l = 2
  ))
plot1
??save(
  filename = paste0("forest_plots/combintaion_all_FU", ".png"),
  plot = last_plot(),
  dpi = 600,
  scale = 1.7,
  width = 6,
  height = 12
)

hr_table_30_com = hr_table_30[type == "combination"]
hr_table_30_com[antibody_n == "IgG Mutants RBD \n Ig??Variants", `:=`(antibody_n = "IgG Mutants RBD \n IgA Variants")]
hr_table_30_com[antibody_n == "IgG Mutants RBD \n IgA Wuhan", `:=`(antibody_n = "IgG Mutants RBD \n IgA Wuhan")]
hr_table_30_com[antibody_n == "BioPlex IgG S2 \n IgG Alinity RBD", `:=`(antib??y_n = "BioPlex IgG S2 \n IgG Alinity RBD")]
hr_table_30_com[, `:=`(antibody_n = factor(
  antibody_n,
  levels = c(
    "IgA Wuhan \n IgA Variants",
    "BioPlex IgG S2 \n IgG Alinity RBD",
    "IgG Alinity RBD \n IgG Mutants RBD",
    "BioPlex IgG S2 \n ??G Mutants RBD",
    "IgG Alinity RBD \n IgA Wuhan",
    "BioPlex IgG S2 \n IgA Variants",
    "BioPlex IgG S2 \n IgA Wuhan",
    "IgG Alinity RBD \n IgA Variants",
    "IgG Mutants RBD \n IgA Wuhan",
    "IgG Mutants RBD \n IgA Variants"
  ),
  labels = c??    "IgA Wuhan \n \u0026        \n IgA Variants ",
    "BioPlex IgG S2 \n \u0026            \n IgG Alinity RBD ",
    "IgG Alinity RBD \n \u0026            \n IgG Mutants RBD ",
    "BioPlex IgG S2 \n \u0026            \n IgG Mutants RBD ",
    "IgG Alini?? RBD \n \u0026            \n IgA Wuhan     ",
    "BioPlex IgG S2 \n \u0026            \n IgA Variants    ",
    "BioPlex IgG S2 \n \u0026            \n IgA Wuhan     ",
    "IgG Alinity RBD \n \u0026            \n IgA Variants    ",
    "IgG Mutants RBD ?? \u0026            \n IgA Wuhan     ",
    "IgG Mutants RBD \n \u0026            \n IgA Variants    "
  )
))]
plot1 <-
  ggplot(subset(hr_table_30_com),
         aes(y = antibody_n, x = hr, color = status)) +
  geom_point(shape = 18,
             size = 5??             position = position_dodge(width = 0.3)) +
  geom_errorbarh(aes(xmin = LL, xmax = UL),
                 height = 0.25,
                 position = position_dodge(width = 0.3)) +
  geom_vline(
    xintercept = 1,
    color = "black",
    linety?? = "dashed",
    cex = 1,
    alpha = 0.3
  ) +
  xlab("Hazard Ratio (95% CI)") +
  ylab(" ") +
  theme_bw() +
  theme(
    panel.border = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.mino??= element_blank(),
    axis.line = element_line(colour = "black", size = 1),
    axis.text.y = element_text(size = 28, colour = "black"),
    axis.text.x.bottom = element_text(size = 28, colour = "black"),
    axis.title.x = element_text(size = 28, colour?? "black"),
    legend.position = "bottom",
    legend.title = element_blank(),
    text = element_text(size  = 28, family = "Times New Roman")
  ) + scale_x_continuous(
    trans = 'log10',
    limits = c(0.1, 100),
    labels = scales::label_number_auto(??  ) + scale_color_manual(values = c("#0F3B5F", "#FF8C00")) + coord_cartesian(xlim = c(0.5, 30))  +
  theme(plot.margin = margin(
    t = 8,
    r = 10,
    b = 0,
    l = 2
  ))
plot1
ggsave(
  filename = paste0("forest_plots/combintaion_T1", ".png"),
  p??t = last_plot(),
  dpi = 600,
  scale = 1.7,
  width = 6,
  height = 12
)
```

```{r}
# Poisson Sensitivity analysis 
variables_all_vector <-
  c(colnames(df_work)[colnames(df_work) %like% "comb_vacc"],
    colnames(df_work)[colnames(df_work) %like% "comb??nvacc"],
    colnames(df_work)[colnames(df_work) %like% "group_vaccinated_no_mid"],
    colnames(df_work)[colnames(df_work) %like% "group_unvaccinated_no_mid"])

df_work[vaccinated == "No", `:=`(follow_up_date = eventdate + days(time_to_event))]
df_work[v??cinated == "Yes", `:=`(dose_number_4_plus_7_days = dose_number_4 + days(7))]
df_work[vaccinated == "Yes", `:=`(follow_up_date = dose_number_4_plus_7_days + days(time_to_event))]

df_analysis_senstivity <-
  rbindlist(list(df_work[vaccinated == "No", .(
  ??new_date = seq(eventdate, follow_up_date, by = "day"),
    gender,
    age_grp,
    sector_of_occuppation_grp,
    hospital,
    time_from_third_vaccine_month,
    vaccinated
  ), by = num]
  , df_work[vaccinated == "Yes", .(
    new_date = seq(eventdate,??ollow_up_date, by = "day"),
    gender,
    age_grp,
    sector_of_occuppation_grp,
    hospital,
    time_from_third_vaccine_month,
    vaccinated
  ), by = num]))

# This section allows to add positive Covid Infection date
df_work[vaccinated == "No", `:??(new_date = eventdate + days(covid_positive_after_enroll_days))]
df_work[vaccinated == "Yes", `:=`(new_date = dose_number_4 + days(covid_positive_after_enroll_days + 7))]
df_analysis_senstivity <-
  df_work[, .(num, new_date, Positive_Covid_num)][df_analy??s_senstivity, on = c("num", "new_date")]
df_analysis_senstivity[, `:=`(Positive_Covid_num = fifelse(is.na(Positive_Covid_num), 0, Positive_Covid_num))]
# Prepare data format for joining and variables for analysis
df_analysis_senstivity[, `:=`(new_date = y??(new_date))]
df_percent_positive_israel[, `:=`(new_date = dmy(date_percent_positive))]
df_analysis_senstivity <-
  df_percent_positive_israel[df_analysis_senstivity, on = "new_date"]
df_analysis_senstivity[, count_app := rowid(num)]
df_analysis_senstivity?? `:=`(time_30 = fifelse(count_app < 31, "<= 30", "> 30"))]
df_analysis_senstivity_30 <- df_analysis_senstivity[count_app < 31]
df_analysis_senstivity_30 <- df_analysis_senstivity[count_app > 30]
# Supplementary Table 3.
# P-values were computed using a tw??sided Poisson regression estimating vaccine efficacy for 30 follow up days. The model was adjusted to the daily proportion of positive PCR tests to Covid-19, age, occupation, medical center, and time from the third vaccination and subjects as a random eff??t.
model <-
  glmer(
    Positive_Covid_num ~ vaccinated +
      percent_pcr +
      age_grp +
      hospital +
      sector_of_occuppation_grp +
      time_from_third_vaccine_month +
      gender + 
      (1|num),
    family = "poisson",
    data = df_an??ysis_senstivity,
    subset = count_app < 31
  )
summ_model <- summ(model, exp = T, confint = T)

write_excel_csv(
  as.data.table(summ_model$coeftable, keep.rownames = TRUE),
  "output/vaccination_effect_pre_30_poisson_results.csv"
)

# Supplementary Tabl? 4.
# P-values were computed using a two-sided Poisson regression estimating vaccine efficacy for 60-90 follow up days. The model was adjusted to the daily proportion of positive PCR tests to Covid-19, age, occupation, medical center, and time from the th??d vaccination and subjects as a random effect.
model <-
  glmer(
    Positive_Covid_num ~ vaccinated +
      percent_pcr +
      age_grp +
      hospital +
      sector_of_occuppation_grp +
      time_from_third_vaccine_month +
      gender +
      (1|num??
    family = "poisson",
    data = df_analysis_senstivity
  )
summ_model <- summ(model, exp = T, confint = T)
write_excel_csv(
  as.data.table(summ_model$coeftable, keep.rownames = TRUE),
  "output/vaccination_effect_all_FU_poisson_results.csv"
)
```

``??r}
# Supplementary Data 6 and 7
col_name_fix_markers <-
  paste0(colnames(df_all_markers_unvacc)[-1], " unvaccinated")
col_name_fix_markers <-
  str_replace_all(string = col_name_fix_markers,
                  pattern = "-",
                  repl = " "?
c?l_name_fix_markers <-
  str_replace_all(string = col_name_fix_markers,
                  pattern = " ",
                  repl = "_")
setnames(df_all_markers_unvacc,
         colnames(df_all_markers_unvacc)[-1],
         col_name_fix_markers)
col_name_f?x_?arkers <-
  paste0(colnames(df_all_markers_vacc)[-1], " vaccinated")
col_name_fix_markers <-
  str_replace_all(string = col_name_fix_markers,
                  pattern = "-",
                  repl = " ")
col_name_fix_markers <-
  str_replace_all(string?= ?ol_name_fix_markers,
                  pattern = " ",
                  repl = "_")
setnames(df_all_markers_vacc,
         colnames(df_all_markers_vacc)[-1],
         col_name_fix_markers)

df_work <- df_all_markers_unvacc[df_work, on = "num"]
df_work <? d?_all_markers_vacc[df_work, on = "num"]


# Supplementary Data 6.
# P-values were computed using a two-sided Cox proportional hazard model comparing infection hazard at 60-90 follow up days in the low-baseline with high-baseline response groups using al? ma?kers. The model estimated HR for the individuals receiving three doses of the Pfizer vaccine. We used calendar days as the time-axis and adjusted for age, occupation, medical center, and time from the third vaccination.
cox_model <-
  coxph(
    Surv(t?me ? time_since_first_enroll, time2 = time_event_calendar, event) ~
      SARS_CoV_2_S_A.23.1_IgG_unvaccinated + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
all_markers_unvaccinated <-
  c?ind?
    as.data.table(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as.data.table(summary(cox_model)$coefficients)[1, 5]
  )

variable_vector <- colnames(df_all_markers_unvacc)
variable_vector <- variable_vector[-1:-2]
for (i in variable_vecto?) {?  cox_syntax <-
    as.formula(
      substitute(
        Surv(time = time_since_first_enroll, time2 = time_event_calendar, event) ~ SARS_CoV_2_S_A.23.1_IgG_unvaccinated + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccin?_mo?th,
        list(SARS_CoV_2_S_A.23.1_IgG_unvaccinated = as.symbol(i))
      )
    )
  model_temp_cox <- coxph(cox_syntax, data = df_work)
  all_markers_unvaccinated <-
    rbindlist(list(
      all_markers_unvaccinated,
      cbind(
        as.data.tab?e(s?mmary(model_temp_cox)$conf.int, keep.rownames = T)[1, ],
        as.data.table(summary(model_temp_cox)$coefficients)[1, 5]
      )
    ))
}

all_markers_unvaccinated[rn %like% "unvaccinatedlow", `:=`(antibody_n = str_sub(rn, 1,-17))]
all_markers_unvacc?nat?d[rn %like% "unvaccinated`low", `:=`(antibody_n = str_sub(rn, 1,-18))]
setorder(all_markers_unvaccinated,-`exp(coef)`)
write_excel_csv(all_markers_unvaccinated,
                "output/all_markers_unvaccinated.csv")

# Supplementary Data 7.
# P-value? were?computed using a two-sided Cox proportional hazard model comparing infection hazard at 60-90 follow up days in the low-baseline with high-baseline response groups using all markers. The model estimated HR for the individuals receiving four doses of t?e Pfi?er vaccine. We used calendar days as the time-axis and adjusted for age, occupation, medical center, and time from the third vaccination.

cox_model <-
  coxph(
    Surv(time = time_since_first_enroll, time2 = time_event_calendar, event) ~ SARS_CoV_2?S_A.2?.1_IgG_vaccinated + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
    data = df_work
  )
all_markers_vaccinated <-
  cbind(
    as.data.table(summary(cox_model)$conf.int, keep.rownames = T)[1, ],
    as.data?table?summary(cox_model)$coefficients)[1, 5]
  )

variable_vector <- colnames(df_all_markers_vacc)
variable_vector <- variable_vector[-1:-2]
for (i in variable_vector) {
  cox_syntax <-
    as.formula(
      substitute(
        Surv(time = time_since_first?enrol?, time2 = time_event_calendar, event) ~ SARS_CoV_2_S_A.23.1_IgG_vaccinated + gender + age_grp + sector_of_occuppation_grp + hospital + time_from_third_vaccine_month,
        list(SARS_CoV_2_S_A.23.1_IgG_vaccinated = as.symbol(i))
      )
    )
  mode?_temp?cox <- coxph(cox_syntax, data = df_work)
  all_markers_vaccinated <-
    rbindlist(list(
      all_markers_vaccinated,
      cbind(
        as.data.table(summary(model_temp_cox)$conf.int, keep.rownames = T)[1, ],
        as.data.table(summary(model_t?mp_co?)$coefficients)[1, 5]
      )
    ))
}

all_markers_vaccinated[rn %like% "vaccinatedlow", `:=`(antibody_n = str_sub(rn, 1,-15))]
all_markers_vaccinated[rn %like% "vaccinated`low", `:=`(antibody_n = str_sub(rn, 1,-16))]

setorder(all_markers_vaccinate?,-`ex?(coef)`)
write_excel_csv(all_markers_vaccinated, "output/all_markers_vaccinated.csv")
```




















